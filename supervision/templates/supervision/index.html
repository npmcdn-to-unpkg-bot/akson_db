<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Akson supervision</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {packages: ['corechart', 'table'], 'language': 'pl'});
        google.charts.setOnLoadCallback(drawDashboard);

        function drawDashboard() {
            var users_data = {{users_data|safe}};
            data_tables = {}
            data_tables_unique = {}
            users_data.forEach(function(user_data) {
                data_tables[user_data.user_id] = google.visualization.arrayToDataTable(user_data.data);
                data_tables_unique[user_data.user_id] = google.visualization.arrayToDataTable(user_data.unique);
            });

            function drawCharts(data_tables, chart, table, title_prefix = "") {
                var options = {
                    title: title_prefix + user_select.options[user_select.selectedIndex].text,
                    chartArea: {width: '70%', height: '80%'},
                    bar: {groupWidth: '100%'},
                    legend: {position: 'right'},
                    height: 400,
                    animation:{
                        startup: true,
                        duration: 500,
                        easing: 'out'
                    }
                };
                var selected_user = user_select.options[user_select.selectedIndex].value;
                var actual_data = data_tables[selected_user];
                chart.draw(actual_data, options);
                table.draw(actual_data, {});
            }

            var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
            var save_chart = document.getElementById('save_chart');
            var table = new google.visualization.Table(document.getElementById('table_div'));

            var chart_unique = new google.visualization.ColumnChart(document.getElementById('chart_unique_div'));
            var save_unique_chart = document.getElementById('save_unique_chart');
            var table_unique = new google.visualization.Table(document.getElementById('table_unique_div'));

            function drawAllCharts() {
                drawCharts(data_tables, chart, table, "Liczba wykonanych ćwiczeń dla osoby: ");
                drawCharts(data_tables_unique, chart_unique, table_unique, "Liczba pacjentów dla osoby: ");
            }

            var user_select = document.getElementById('user_select');
            user_select.onkeyup = user_select.onchange = drawAllCharts;
            user_select.focus();

            google.visualization.events.addListener(chart, 'ready', function () {
                save_chart.href = chart.getImageURI();
                save_chart.download = user_select.options[user_select.selectedIndex].text + ".png";
            });
            google.visualization.events.addListener(chart_unique, 'ready', function () {
                save_unique_chart.href = chart_unique.getImageURI();
                save_unique_chart.download = user_select.options[user_select.selectedIndex].text + ".png";
            });

            drawAllCharts();
        }
    </script>
</head>
<body>
    <select id="user_select" name="select">
        {% for user in users %}
            <option value="{{ user.id }}">{{ user.full_name }}</option>
        {% endfor %}
    </select>
    <div id="chart_div"></div>
    <a href="" id="save_chart">Zapisz wykres do pliku</a>
    <div id="table_div"></div>
    <div id="chart_unique_div"></div>
    <a href="" id="save_unique_chart">Zapisz wykres do pliku</a>
    <div id="table_unique_div"></div>
</body>
</html>
